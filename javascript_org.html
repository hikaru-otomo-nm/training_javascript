<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <title>お問い合わせフォーム</title>
  <script>
    //初期処理
    window.onload = function() {
      // document.getElementById("input_address").style.display = "none";
    }

    const checkItems = {
      lastname: {
        'name': '名前（氏）',
        'require': true,
        'max_size': 50,
        'regex': '^[^\x01-\x7E\xA1-\xDF]+$'
      },
      firstname: {
        'name': '名前（名）',
        'require': true,
        'max_size': 50,
        'regex': '^[^\x01-\x7E\xA1-\xDF]+$'
      },
      lastname_kana: {
        'name': 'フリガナ（氏）',
        'require': true,
        'max_size': 100,
        'regex': '^[\u30a0-\u30ff]+$'
      },
      firstname_kana: {
        'name': 'フリガナ（名）',
        'require': true,
        'max_size': 100,
        'regex': '^[\u30a0-\u30ff]+$'
      },
      postal_no: {
        'name': '郵便番号',
        'require': true,
        'max_size': 7,
        'regex': '[0-9]{3}[0-9]{4}'
      },
      address: {
        'name': '住所',
        'require': true,
        'max_size': 100
      },
      inquiry: {
        'name': 'お問い合わせ内容',
        'require': true,
        'max_size': 1000
      },
      email: {
        'name': 'メールアドレス',
        'require': true,
        'regex': '[A-Za-z0-9\._+]+@[A-Za-z]+\.[A-Za-z]'
      }
    };

    function check(item) {
      var errorMessages = {};
      //値を取得
      var getValue = document.getElementById(item).value;

      var checkItem = checkItems[item];

      for (let k in checkItem) {
        var errorMessageId = item + "_" + k;
        var errorMessageP = document.getElementById(errorMessageId);

        // 既存のエラーメッセージを削除
        if (errorMessageP != null) {
          errorMessageP.remove();
        }

        // 必須チェック
        if (k == "require" && !getValue) {
          errorMessages.require = checkItem.name + 'は必須です';
        }

        // 長さチェック
        if (k == "max_size" && getValue.length > checkItem.max_size) {
          errorMessages.max_size = checkItem.name + 'が長すぎます';
        }

        var pattern = new RegExp(checkItem.regex);

        // パターンチェック
        if (k == "regex" && null == getValue.match(pattern) && getValue != "") {
          errorMessages.regex = checkItem.name + 'は文字形式が違います';
        }
      }

      var error = document.getElementById("error");

      for (let k in errorMessages) {
        // メッセージのDOMを作る
        var p_errormsg = "<p style='color:red' id='" + item + "_" + k + "'>" + errorMessages[k] + "</p>"
        // 作ったDOMエラーのタグに追加する
        error.insertAdjacentHTML('beforeend', p_errormsg);
      }
    }

    //採用について
    function category() {
      var category_value = document.getElementById("category").value;
      if (category_value == "category_no3") {
        alert("「採用について」が選択されました。");
        document.getElementById("input_address").style.display = "block";
      } else {
        document.getElementById("input_address").style.display = "none";
      }
    }


    $(function() {
      //検索ボタンをクリックされたときに実行
      $("#search_button").click(function() {
        //入力値をセット
        var param = {
          zipcode: $('#postal_no').val()
        }
        //zipcloudのAPIのURL
        var send_url = "http://zipcloud.ibsnet.co.jp/api/search";
        $.ajax({
          type: "GET",
          cache: false,
          data: param,
          url: send_url,
          dataType: "json",
          success: function(res) {
            if (res.status == 200 && res.result != null ) {
              //正常終了
              var html = '';
              for (var i = 0; i < res.results.length; i++) {
                var result = res.results[i];
                console.log(res.results);
                html += result.address1;
                html += result.address2;
                html += result.address3;
              }
              $('#zip_result').html(html);
            } else {
              //エラー
              $('#zip_result').html(res.message);

            }
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log(XMLHttpRequest);
          }
        });
      });
    });
  </script>
</head>

<body>
  <h2>お問い合わせフォーム</h2>
  <div id="error"></div>

  <div class="input_name">
    <label for="lastname">名前（氏）</label>
    <input type="text" id="lastname" name="lastname" onInput="check('lastname')"> ※全角５０文字以内<br>

    <label for="firstname">名前（名）</label>
    <input type="text" id="firstname" name="firstname" onInput="check('firstname')"> ※全角５０文字以内<br>

    <label for="lastname_kana">フリガナ（氏）</label>
    <input type="text" id="lastname_kana" name="lastname_kana" onInput="check('lastname_kana')"> ※全角１００文字以内<br>

    <label for="firstname_kana">フリガナ（名）</label>
    <input type="text" id="firstname_kana" name="firstname_kana" onInput="check('firstname_kana')"> ※全角１００文字以内<br>
  </div><br>

  <div class="input_email">
    <label for="email">メールアドレス</label>
    <input type="text" id="email" name="email" onInput="check('email')"> <br>
  </div><br>

  <div id="input_category">
    <label for="category">お問い合わせ<br>カテゴリ</label>
    <select id="category" onchange="category()">
      <option value=""></option>
      <option value="category_no1">システムの使用方法について</option>
      <option value="category_no2">システムの不具合について</option>
      <option value="category_no3">採用について</option>
    </select>
  </div>

  <br>

  <div id="input_address">
    <label for="postal_no">郵便番号</label>
    <input type="text" name="postal_no" id="postal_no" onInput="check('postal_no')">
    <input type="button" id="search_button" value="検索"><br>

    <div id="zip_result">住所を出力</div><br>

    <label for="address">住所</label>
    <input type="text" name="address" id="address" onInput="addressSearch('address')"> ※全角１００文字以内<br>
    <br>
  </div>

  <div class="input_inquiry">
    <label for="inquiry">お問い合わせ<br>内容</label><br>
    <textarea id="inquiry" name="inquiry" onInput="check('inquiry')"></textarea> ※全角１００文字以内<br>
  </div>

  <button id="check_button" onClick='check()'>送信</button>
</body>

</html>
